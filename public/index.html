<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Varsonalia - Gra Terenowa</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background-color: #f0f0f0;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    header {
      background-color: #4B0082;
      color: white;
      text-align: center;
      padding: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    .container {
      flex: 1;
      padding: 20px;
      max-width: 100%;
      margin: 0 auto;
    }

    .team-selection {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-bottom: 20px;
    }

    .team-btn {
      background-color: #6a0dad;
      color: white;
      border: none;
      padding: 15px;
      font-size: 18px;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.2s, background-color 0.3s;
    }

    .team-btn:hover {
      background-color: #8e44ad;
      transform: scale(1.03);
    }

    .team-password-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .team-password-container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      text-align: center;
      width: 90%;
      max-width: 400px;
    }

    .team-password-container input {
      width: 100%;
      padding: 10px;
      margin: 15px 0;
      border: 1px solid #ddd;
      border-radius: 5px;
    }

    .team-password-container button {
      background-color: #6a0dad;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
    }

    .team-password-container button:hover {
      background-color: #8e44ad;
    }

    #map {
      height: 350px;
      width: 100%;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .tabs {
      display: flex;
      border-bottom: 1px solid #ddd;
      margin-bottom: 15px;
    }

    .tab {
      padding: 10px 15px;
      cursor: pointer;
      background: #eee;
      border-radius: 5px 5px 0 0;
      margin-right: 5px;
    }

    .tab.active {
      background: #6a0dad;
      color: white;
    }

    .tab-content {
      display: none;
      padding: 15px;
      background: white;
      border-radius: 0 0 8px 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .tab-content.active {
      display: block;
    }

    .station-list {
      list-style-type: none;
    }

    .station-item {
      padding: 12px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .station-number {
      font-weight: bold;
      background: #6a0dad;
      color: white;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 10px;
    }

    .station-name {
      flex: 1;
    }

    .station-status {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background-color: #ddd;
    }

    .station-status.completed {
      background-color: #27ae60;
    }

    .bingo-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
      margin-top: 15px;
    }

    .bingo-item {
      background: white;
      border: 1px solid #ddd;
      padding: 12px 8px;
      text-align: center;
      border-radius: 5px;
      font-size: 12px;
      min-height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .bingo-item.marked {
      background-color: #9b59b6;
      color: white;
    }

    .score-section {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .score-display {
      font-size: 24px;
      font-weight: bold;
      text-align: center;
      margin-bottom: 15px;
    }

    .admin-section {
      margin-top: 20px;
      padding: 15px;
      background: #f8f8f8;
      border-radius: 8px;
      border: 1px dashed #ccc;
    }

    .admin-controls {
      display: none;
    }

    input, button {
      padding: 10px;
      margin: 5px 0;
      width: 100%;
      border-radius: 5px;
      border: 1px solid #ddd;
    }

    button {
      background-color: #6a0dad;
      color: white;
      border: none;
      cursor: pointer;
    }

    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }

    footer {
      text-align: center;
      padding: 15px;
      background-color: #4B0082;
      color: white;
      font-size: 0.8rem;
      margin-top: auto;
    }

    .hidden {
      display: none;
    }

    .back-btn {
      margin-bottom: 15px;
      background-color: #555;
    }

    .team-dashboard {
      display: none;
    }

    .team-header {
      background: #6a0dad;
      color: white;
      padding: 10px;
      text-align: center;
      border-radius: 8px 8px 0 0;
      margin-bottom: 15px;
    }
    /* Dodaj do sekcji CSS */
    .photo-preview {
      max-width: 100%;
      max-height: 200px;
      margin: 10px 0;
      border-radius: 5px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }

    .bingo-photo-indicator {
      position: absolute;
      top: 5px;
      right: 5px;
      width: 16px;
      height: 16px;
      background-color: #3498db;
      border-radius: 50%;
    }

    .bingo-item {
      position: relative;
    }

    .station-password-hint {
      font-size: 0.8rem;
      color: #777;
      margin-top: 5px;
    }

    #photo-upload-form {
      display: flex;
      flex-direction: column;
    }

    #photo-upload-form input[type="file"] {
      margin: 15px 0;
    }

    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
<header>
  <h1>Varsonalia 2025</h1>
  <p>Gra Terenowa</p>
</header>

<div class="container">
  <!-- Strona wyboru drużyny -->
  <div id="team-selection-page">
    <h2>Wybierz swoją drużynę:</h2>
    <div class="team-selection">
      <button class="team-btn" data-team="1">Drużyna Czerwona</button>
      <button class="team-btn" data-team="2">Drużyna Niebieska</button>
      <button class="team-btn" data-team="3">Drużyna Zielona</button>
      <button class="team-btn" data-team="4">Drużyna Żółta</button>
      <button class="team-btn" data-team="5">Drużyna Fioletowa</button>
      <button class="team-btn" data-team="6">Drużyna Pomarańczowa</button>
    </div>

    <div class="admin-section">
      <h3>Panel Prowadzącego</h3>
      <input type="password" id="admin-password" placeholder="Hasło prowadzącego">
      <button id="admin-login-btn">Zaloguj</button>
    </div>
  </div>

  <!-- Modal hasła drużyny -->
  <div id="team-password-modal" class="team-password-modal">
    <div class="team-password-container">
      <h2 id="team-password-title">Hasło drużyny</h2>
      <input type="password" id="team-password-input" placeholder="Wprowadź hasło drużyny">
      <button id="team-password-submit">Zatwierdź</button>
    </div>
  </div>

  <!-- Panel drużyny -->
  <div id="team-dashboard" class="team-dashboard">
    <div class="team-header">
      <h2 id="team-name-display">Drużyna</h2>
    </div>

    <button class="back-btn" id="back-to-teams">← Powrót do wyboru drużyny</button>

    <div class="tabs">
      <div class="tab active" data-tab="map-tab">Mapa</div>
      <div class="tab" data-tab="stations-tab">Stacje</div>
      <div class="tab" data-tab="bingo-tab">Bingo</div>
      <div class="tab" data-tab="score-tab">Punkty</div>
    </div>

    <div id="map-tab" class="tab-content active">
      <div id="map"></div>
      <div class="station-info">
        <h3>Twoje stacje:</h3>
        <ul class="station-list" id="map-station-list">
          <!-- Stacje będą generowane dynamicznie -->
        </ul>
      </div>
    </div>

    <div id="stations-tab" class="tab-content">
      <h3>Twoja kolejność stacji:</h3>
      <ul class="station-list" id="detailed-station-list">
        <!-- Stacje będą generowane dynamicznie -->
      </ul>
    </div>

    <div id="bingo-tab" class="tab-content">
      <h3>Zadania Bingo</h3>
      <p>Kliknij na zadania, które udało Ci się wykonać między stacjami!</p>
      <div class="bingo-grid" id="bingo-grid">
        <!-- Zadania bingo będą generowane dynamicznie -->
      </div>
      <p class="score-display" id="bingo-score">Bingo: 0/25</p>
    </div>

    <div id="score-tab" class="tab-content">
      <div class="score-section">
        <h3>Twój wynik</h3>
        <div class="score-display" id="total-score">0 punktów</div>

        <div id="score-breakdown">
          <p>Stacje: <span id="stations-score">0</span> pkt</p>
          <p>Bingo: <span id="bingo-points">0</span> pkt</p>
        </div>
      </div>

      <div class="admin-section">
        <h3>Dodaj punkty (tylko prowadzący)</h3>
        <input type="password" id="station-password" placeholder="Hasło prowadzącego">
        <select id="station-select">
          <option value="">Wybierz stację</option>
          <!-- Opcje będą generowane dynamicznie -->
        </select>
        <input type="number" id="points-input" min="0" max="100" value="10" placeholder="Liczba punktów">
        <button id="add-points-btn" disabled>Dodaj punkty</button>
      </div>
    </div>
  </div>

  <!-- Panel admina -->
  <div id="admin-panel" class="hidden">
    <button class="back-btn" id="admin-back">← Powrót do wyboru drużyny</button>
    <h2>Panel Prowadzącego</h2>

    <div class="admin-controls">
      <h3>Status drużyn</h3>
      <ul id="admin-team-list">
        <!-- Lista drużyn będzie generowana dynamicznie -->
      </ul>

      <div class="admin-section">
        <h3>Resetuj grę</h3>
        <p>Uwaga: Ta akcja usunie wszystkie dane gry!</p>
        <button id="reset-game-btn">Resetuj grę</button>
      </div>
    </div>
  </div>
</div>

<footer>
  <p>Varsonalia 2025 &copy; Politechnika Warszawska</p>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
<script>
  // Dane gry
  const ADMIN_PASSWORD = "varsonalia2025"; // Hasło prowadzącego

  // Hasła dla drużyn (tymczasowe)
  const TEAM_PASSWORDS = {
    1: "red",  // Drużyna Czerwona
    2: "blue", // Drużyna Niebieska
    3: "green",   // Drużyna Zielona
    4: "yellow",     // Drużyna Żółta
    5: "purple", // Drużyna Fioletowa
    6: "orange" // Drużyna Pomarańczowa
  };

  // Stacje (lokalizacje na Polu Mokotowskim)
  const stations = [
    { id: 1, name: "Stacja PW", lat: 52.214484, lng: 21.013137, points: 0 },
    { id: 2, name: "Escape room", lat: 52.215128, lng: 21.014872, points: 0 },
    { id: 3, name: "Strzelaj z WAT'em", lat: 52.214367, lng: 21.011802, points: 0 },
    { id: 4, name: "Puppy joga", lat: 52.214607, lng: 21.009114, points: 0 },
    { id: 5, name: "Kalambury na hamakach", lat: 52.215849, lng: 21.009410, points: 0 },
    { id: 6, name: "Stacja Juwe", lat: 52.213746, lng: 21.009683, points: 0 }
  ];

  // Zadania bingo
  const bingoTasks = [
    "Zrób selfie z osobą w koszulce Varsonaliów",
    "Znajdź i zrób zdjęcie najmniejszej fontanny",
    "Zrób zdjęcie z członkiem innej drużyny",
    "Zrób zdjęcie rysunku maskotki Varsonaliów",
    "Ułóż akronim ze słowa JUWENALIA",
    "Zdjęcie jak śpiewasz piosenki ulubionego artysty z tegorocznych Varsonaliów",
    "Zdjęcie kogoś zakamuflowanego",
    "Zdjęcie ze zwierzęciem",
    "Upleć wianek z kwiatów",
    "Zrób zdjęcie całej drużyny skaczącej",
    "Wymyśl hasło reklamujące Twoją uczelnię",
    "Zbierz 5 różnych liści",
    "Zagraj w kółko i krzyżyk z przechodniem",
    "Nagraj 5-sekundowy filmik ze zwolnionym tempem",
    "Zrób zdjęcie z kimś w okularach przeciwsłonecznych",
    "Zagraj szybką partię papier-kamień-nożyce z 3 osobami",
    "Napisz wiersz o pogodzie",
    "Narysuj maskotkę Varsonaliów z zamkniętymi oczami",
    "Zagadaj do kogoś po angielsku",
    "Zrób ludzką piramidę (min. 3 osoby)",
    "Naśladuj dźwięk zwierzęcia przez 5 sekund",
    "Zrób zdjęcie z najwyższą osobą, którą spotkasz",
    "Wymyśl mema o życiu studenckim",
    "Zrób zdjęcie z kimś, kto ma takie samo imię jak Ty",
    "Znajdź i sfotografuj coś w kształcie serca"
  ];

  // Zmienne stanu aplikacji
  let currentTeam = null;
  let map = null;
  let markers = [];


  // Zamień funkcję shuffleStations na generateTeamRoutes
  function generateTeamRoutes() {
    // Generujemy trasy dla wszystkich drużyn tak, żeby się nie korkowały
    // Każda drużyna ma inną stację początkową, ale wszystkie idą "zgodnie z ruchem wskazówek zegara"

    // Przygotuj sześć różnych tras (każda zaczyna od innej stacji, ale zachowuje kolejność)
    const routes = {};

    // Bazowa kolejność stacji (zgodnie z ruchem wskazówek zegara)
    const baseOrder = [1, 2, 3, 4, 5, 6];

    // Dla każdej drużyny tworzymy trasę zaczynającą od innej stacji
    for (let teamId = 1; teamId <= 6; teamId++) {
      // Przesuń kolejność, aby każda drużyna zaczynała od innej stacji
      // Można to zrozumieć jako "rotację" bazowej trasy
      let startIndex = (teamId - 1) % 6;
      let teamRoute = [...baseOrder.slice(startIndex), ...baseOrder.slice(0, startIndex)];
      routes[teamId] = teamRoute;
    }

    return routes;
  }

  // Zmodyfikuj inicjalizację teamData, aby używała nowej funkcji trasy
  let teamData = {
    1: { name: "Drużyna Czerwona", color: "#e74c3c", completedStations: {}, bingoMarked: {}, bingoPhotos: {}, totalPoints: 0 },
    2: { name: "Drużyna Niebieska", color: "#3498db", completedStations: {}, bingoMarked: {}, bingoPhotos: {}, totalPoints: 0 },
    3: { name: "Drużyna Zielona", color: "#2ecc71", completedStations: {}, bingoMarked: {}, bingoPhotos: {}, totalPoints: 0 },
    4: { name: "Drużyna Żółta", color: "#f1c40f", completedStations: {}, bingoMarked: {}, bingoPhotos: {}, totalPoints: 0 },
    5: { name: "Drużyna Fioletowa", color: "#9b59b6", completedStations: {}, bingoMarked: {}, bingoPhotos: {}, totalPoints: 0 },
    6: { name: "Drużyna Pomarańczowa", color: "#e67e22", completedStations: {}, bingoMarked: {}, bingoPhotos: {}, totalPoints: 0 }
  };

  // Wygeneruj trasy i przypisz je do drużyn
  const teamRoutes = generateTeamRoutes();
  Object.keys(teamData).forEach(teamId => {
    teamData[teamId].stationOrder = teamRoutes[teamId];
  });

  // Inicjalizacja po załadowaniu strony
  document.addEventListener('DOMContentLoaded', function() {
    // Ładowanie zapisanych danych z localStorage jeśli są dostępne
    loadGameState();

    // Obsługa wyboru drużyny
    document.querySelectorAll('.team-btn').forEach(button => {
      button.addEventListener('click', function() {
        const teamId = parseInt(this.getAttribute('data-team'));
        showTeamPasswordModal(teamId);
      });
    });

    // Obsługa zatwierdzenia hasła drużyny
    document.getElementById('team-password-submit').addEventListener('click', function() {
      const teamPasswordInput = document.getElementById('team-password-input');
      const teamId = parseInt(document.getElementById('team-password-modal').dataset.team);
      
      if (teamPasswordInput.value === TEAM_PASSWORDS[teamId]) {
        document.getElementById('team-password-modal').style.display = 'none';
        selectTeam(teamId);
      } else {
        alert('Niepoprawne hasło drużyny!');
        teamPasswordInput.value = '';
      }
    });

    // Obsługa przycisków nawigacji
    document.getElementById('back-to-teams').addEventListener('click', backToTeamSelection);
    document.getElementById('admin-back').addEventListener('click', backToTeamSelection);

    // Obsługa logowania admina
    document.getElementById('admin-login-btn').addEventListener('click', loginAdmin);

    // Obsługa dodawania punktów
    document.getElementById('station-password').addEventListener('input', validateStationForm);
    document.getElementById('station-select').addEventListener('change', validateStationForm);
    document.getElementById('points-input').addEventListener('input', validateStationForm);
    document.getElementById('add-points-btn').addEventListener('click', addPoints);

    // Obsługa resetowania gry
    document.getElementById('reset-game-btn').addEventListener('click', resetGame);

    // Obsługa zakładek
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', function() {
        const tabId = this.getAttribute('data-tab');
        switchTab(tabId);
      });
    });

    // Inicjalizacja mapy przy pierwszym przejściu do zakładki mapa
    document.querySelector('[data-tab="map-tab"]').addEventListener('click', function() {
      if (!map) {
        setTimeout(initMap, 100);
      }
    });
  });

  // Funkcja wyświetlania modala z hasłem drużyny
  function showTeamPasswordModal(teamId) {
    const modal = document.getElementById('team-password-modal');
    const teamPasswordTitle = document.getElementById('team-password-title');
    const teamName = {
      1: "Czerwonej",
      2: "Niebieskiej", 
      3: "Zielonej",
      4: "Żółtej",
      5: "Fioletowej",
      6: "Pomarańczowej"
    }[teamId];

    teamPasswordTitle.textContent = `Hasło drużyny ${teamName}`;
    modal.dataset.team = teamId;
    modal.style.display = 'flex';
    document.getElementById('team-password-input').value = '';
  }

  // Funkcja wyboru drużyny
  function selectTeam(teamId) {
    currentTeam = teamId;

    // Aktualizacja interfejsu
    document.getElementById('team-selection-page').style.display = 'none';
    document.getElementById('team-dashboard').style.display = 'block';
    document.getElementById('admin-panel').style.display = 'none';

    // Ustaw nazwę drużyny
    document.getElementById('team-name-display').textContent = teamData[teamId].name;
    document.documentElement.style.setProperty('--team-color', teamData[teamId].color);

    // Zmodyfikuj panel dodawania punktów w HTML - zakładka score-tab
    document.getElementById('score-tab').innerHTML = `
  <div class="score-section">
    <h3>Twój wynik</h3>
    <div class="score-display" id="total-score">0 punktów</div>

    <div id="score-breakdown">
      <p>Stacje: <span id="stations-score">0</span> pkt</p>
      <p>Bingo: <span id="bingo-points">0</span> pkt</p>
    </div>
  </div>

  <div class="admin-section">
    <h3>Dodaj punkty (tylko prowadzący stację)</h3>
    <select id="station-select">
      <option value="">Wybierz stację</option>
      <!-- Opcje będą generowane dynamicznie -->
    </select>
    <input type="password" id="station-password" placeholder="Hasło stacji">
    <input type="number" id="points-input" min="0" max="100" value="10" placeholder="Liczba punktów">
    <button id="add-points-btn">Dodaj punkty</button>
  </div>
`;

// Dodaj stałe hasła stacji
    const STATION_PASSWORDS = {
      1: "stacjaPW",
      2: "escaperoom",
      3: "strzelaj",
      4: "joga",
      5: "hamaki",
      6: "juwe"
    };

// Zmodyfikowana funkcja walidacji formularza dodawania punktów
    function validateStationForm() {
      const password = document.getElementById('station-password').value;
      const stationId = document.getElementById('station-select').value;
      const points = document.getElementById('points-input').value;

      // Nie wymagamy już sprawdzania hasła admina - weryfikujemy hasło stacji
      const isValid = stationId && points;
      document.getElementById('add-points-btn').disabled = !isValid;
    }

// Zmodyfikowana funkcja dodawania punktów
    function addPoints() {
      const stationId = parseInt(document.getElementById('station-select').value);
      const password = document.getElementById('station-password').value;
      const points = parseInt(document.getElementById('points-input').value);

      if (!stationId || isNaN(points)) {
        alert('Wybierz stację i podaj liczbę punktów!');
        return;
      }

      // Używamy API do weryfikacji hasła stacji
      fetch('/api/validate-station', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          stationPassword: password,
          teamId: currentTeam,
          stationId: stationId,
          points: points
        })
      })
              .then(response => {
                if (!response.ok) {
                  throw new Error('Błąd weryfikacji stacji');
                }
                return response.json();
              })
              .then(data => {
                // Aktualizuj lokalny stan po potwierdzeniu przez serwer
                teamData[currentTeam].completedStations[stationId] = points;

                // Aktualizuj interfejs
                generateStationLists();
                updateScores();

                // Resetuj formularz
                document.getElementById('station-password').value = '';
                document.getElementById('station-select').value = '';
                document.getElementById('points-input').value = '10';
                document.getElementById('add-points-btn').disabled = true;

                // Odświeżamy dane z serwera po pomyślnym dodaniu punktów
                loadGameState();

                alert(`Dodano ${points} punktów dla stacji ${stationId}!`);
              })
              .catch(error => {
                console.error('Error adding points:', error);
                alert('Nie udało się dodać punktów. Sprawdź hasło stacji i spróbuj ponownie.');
              });
    }

    // Zainicjalizuj mapę jeśli jesteśmy na zakładce mapy
    if (document.getElementById('map-tab').classList.contains('active')) {
      setTimeout(initMap, 100);
    }

    // Generuj listę stacji dla tej drużyny
    generateStationLists();

    // Generuj siatkę bingo
    generateBingoGrid();

    // Aktualizuj wyniki
    updateScores();

    // Generuj opcje wyboru stacji w panelu dodawania punktów
    generateStationOptions();
  }

  // Powrót to wyboru drużyny
  function backToTeamSelection() {
    document.getElementById('team-selection-page').style.display = 'block';
    document.getElementById('team-dashboard').style.display = 'none';
    document.getElementById('admin-panel').style.display = 'none';
    document.getElementById('team-password-modal').style.display = 'none';
    currentTeam = null;

    // Zapisz stan gry
    saveGameState();
  }

  // Funkcja logowania administratora
  function loginAdmin() {
    const password = document.getElementById('admin-password').value;

    if (password === ADMIN_PASSWORD) {
      document.getElementById('team-selection-page').style.display = 'none';
      document.getElementById('team-dashboard').style.display = 'none';
      document.getElementById('admin-panel').style.display = 'block';

      // Pokaż kontrolki admina
      document.querySelector('.admin-controls').style.display = 'block';

      // Wygeneruj listę drużyn
      generateAdminTeamList();
    } else {
      alert('Niepoprawne hasło prowadzącego!');
    }
  }

  // Funkcja generująca listę drużyn dla admina
  function generateAdminTeamList() {
    const teamList = document.getElementById('admin-team-list');
    teamList.innerHTML = '';

    Object.keys(teamData).forEach(teamId => {
      const team = teamData[teamId];
      const li = document.createElement('li');
      li.className = 'station-item';

      let completedCount = 0;
      Object.values(team.completedStations).forEach(status => {
        if (status) completedCount++;
      });

      let bingoCount = 0;
      Object.values(team.bingoMarked).forEach(marked => {
        if (marked) bingoCount++;
      });

      li.innerHTML = `
                    <span style="color: ${team.color}">■</span>
                    <span class="station-name">${team.name}</span>
                    <span>Stacje: ${completedCount}/6</span>
                    <span>Bingo: ${bingoCount}/25</span>
                    <span>Punkty: ${team.totalPoints}</span>
                `;

      teamList.appendChild(li);
    });
  }

  // Funkcja inicjalizująca mapę
  function initMap() {
    if (map) return; // Map already initialized

    // Inicjalizacja mapy na Polach Mokotowskich
    map = L.map('map').setView([52.21506704186823, 21.01251276342761], 16);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // Dodaj markery stacji
    markers = [];
    const teamStationOrder = teamData[currentTeam].stationOrder;

    teamStationOrder.forEach((stationId, index) => {
      const station = stations.find(s => s.id === stationId);
      const stationNumber = index + 1;

      const customIcon = L.divIcon({
        html: `<div style="background-color: ${teamData[currentTeam].color}; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold;">${stationNumber}</div>`,
        className: '',
        iconSize: [30, 30]
      });

      const marker = L.marker([station.lat, station.lng], { icon: customIcon }).addTo(map);
      marker.bindPopup(`<b>${station.name}</b><br>${station.description}<br>Stacja ${stationNumber} z 6`);
      markers.push(marker);
    });

    // Połącz markery linią w kolejności odwiedzania
    const coordinates = teamStationOrder.map(stationId => {
      const station = stations.find(s => s.id === stationId);
      return [station.lat, station.lng];
    });

    const polyline = L.polyline(coordinates, {
      color: teamData[currentTeam].color,
      weight: 3,
      opacity: 0.7,
      dashArray: '10, 10'
    }).addTo(map);
  }

  // Funkcja generująca listę stacji
  function generateStationLists() {
    const mapList = document.getElementById('map-station-list');
    const detailedList = document.getElementById('detailed-station-list');

    mapList.innerHTML = '';
    detailedList.innerHTML = '';

    const teamStationOrder = teamData[currentTeam].stationOrder;

    teamStationOrder.forEach((stationId, index) => {
      const station = stations.find(s => s.id === stationId);
      const stationNumber = index + 1;
      const isCompleted = teamData[currentTeam].completedStations[stationId];
      const stationPoints = station.points || 0;

      // Lista na zakładce mapy
      const mapLi = document.createElement('li');
      mapLi.className = 'station-item';
      mapLi.innerHTML = `
                    <span class="station-number">${stationNumber}</span>
                    <span class="station-name">${station.name}</span>
                    <span class="station-status ${isCompleted ? 'completed' : ''}"></span>
                `;
      mapList.appendChild(mapLi);

      // Szczegółowa lista na zakładce stacji
      const detailedLi = document.createElement('li');
      detailedLi.className = 'station-item';
      detailedLi.innerHTML = `
                    <span class="station-number">${stationNumber}</span>
                    <div class="station-details">
                        <div class="station-name">${station.name}</div>
                        <div class="station-desc">${station.description}</div>
                        ${isCompleted ? `<div class="station-points">Zdobyte punkty: ${teamData[currentTeam].completedStations[stationId]} pkt</div>` : ''}
                    </div>
                    <span class="station-status ${isCompleted ? 'completed' : ''}"></span>
                `;
      detailedList.appendChild(detailedLi);
    });
  }

  // Funkcja generująca siatkę bingo
  function generateBingoGrid() {
    const bingoGrid = document.getElementById('bingo-grid');
    bingoGrid.innerHTML = '';

    bingoTasks.forEach((task, index) => {
      const isMarked = teamData[currentTeam].bingoMarked[index];
      const bingoItem = document.createElement('div');
      bingoItem.className = `bingo-item ${isMarked ? 'marked' : ''}`;
      bingoItem.textContent = task;
      bingoItem.dataset.index = index;

      bingoItem.addEventListener('click', toggleBingoItem);

      bingoGrid.appendChild(bingoItem);
    });

    updateBingoScore();
  }

  // Zmodyfikowana funkcja toggleBingoItem z obsługą przesyłania zdjęć
  function toggleBingoItem() {
    const index = parseInt(this.dataset.index);

    // Jeśli element nie jest jeszcze zaznaczony, pozwól użytkownikowi przesłać zdjęcie
    if (!teamData[currentTeam].bingoMarked[index]) {
      showPhotoUploadModal(index);
    } else {
      // Jeśli jest już zaznaczony, pokaż przesłane zdjęcie
      if (teamData[currentTeam].bingoPhotos && teamData[currentTeam].bingoPhotos[index]) {
        showBingoPhoto(index);
      } else {
        // Jeśli nie ma zdjęcia (starsza wersja), po prostu odznacz
        teamData[currentTeam].bingoMarked[index] = false;
        this.classList.remove('marked');
        updateBingoScore();
        updateScores();
        saveGameState();
      }
    }
  }

  // Funkcja pokazująca modal do przesyłania zdjęć
  function showPhotoUploadModal(taskIndex) {
    const task = bingoTasks[taskIndex];

    // Stwórz modal
    const modal = document.createElement('div');
    modal.className = 'team-password-modal';
    modal.style.display = 'flex';
    modal.id = 'photo-upload-modal';

    modal.innerHTML = `
    <div class="team-password-container">
      <h2>Prześlij zdjęcie</h2>
      <p>${task}</p>
      <form id="photo-upload-form">
        <input type="file" id="bingo-photo" accept="image/*" capture="camera">
        <div style="margin: 15px 0;">
          <button type="submit" id="photo-submit">Prześlij zdjęcie</button>
          <button type="button" id="cancel-upload">Anuluj</button>
        </div>
      </form>
    </div>
  `;

    document.body.appendChild(modal);

    // Obsługa anulowania
    document.getElementById('cancel-upload').addEventListener('click', function() {
      document.body.removeChild(modal);
    });

    // Obsługa przesyłania zdjęcia
    document.getElementById('photo-upload-form').addEventListener('submit', function(e) {
      e.preventDefault();

      const fileInput = document.getElementById('bingo-photo');
      if (!fileInput.files.length) {
        alert('Wybierz zdjęcie!');
        return;
      }

      const formData = new FormData();
      formData.append('bingoPhoto', fileInput.files[0]);

      // Pokazuj komunikat o ładowaniu
      const submitBtn = document.getElementById('photo-submit');
      const cancelBtn = document.getElementById('cancel-upload');
      submitBtn.disabled = true;
      cancelBtn.disabled = true;
      submitBtn.textContent = 'Wysyłanie...';

      // Wyślij zdjęcie na serwer
      fetch(`/api/upload-bingo/${currentTeam}/${taskIndex}`, {
        method: 'POST',
        body: formData
      })
              .then(response => {
                if (!response.ok) {
                  throw new Error('Przesyłanie zdjęcia nie powiodło się');
                }
                return response.json();
              })
              .then(data => {
                // Zaktualizuj dane drużyny
                teamData[currentTeam].bingoMarked[taskIndex] = true;

                if (!teamData[currentTeam].bingoPhotos) {
                  teamData[currentTeam].bingoPhotos = {};
                }
                teamData[currentTeam].bingoPhotos[taskIndex] = data.photoPath;

                // Zaktualizuj UI
                document.querySelector(`.bingo-item[data-index="${taskIndex}"]`).classList.add('marked');
                updateBingoScore();
                updateScores();
                saveGameState();

                // Zamknij modal
                document.body.removeChild(modal);
              })
              .catch(error => {
                console.error('Error uploading photo:', error);
                alert('Nie udało się przesłać zdjęcia. Spróbuj ponownie.');
                submitBtn.disabled = false;
                cancelBtn.disabled = false;
                submitBtn.textContent = 'Prześlij zdjęcie';
              });
    });
  }

  // Funkcja do pokazywania przesłanego wcześniej zdjęcia
  function showBingoPhoto(taskIndex) {
    const photoPath = teamData[currentTeam].bingoPhotos[taskIndex];

    // Stwórz modal ze zdjęciem
    const modal = document.createElement('div');
    modal.className = 'team-password-modal';
    modal.style.display = 'flex';

    modal.innerHTML = `
    <div class="team-password-container" style="max-width: 90%">
      <h2>${bingoTasks[taskIndex]}</h2>
      <div style="margin: 15px 0; max-width: 100%; overflow: hidden;">
        <img src="${photoPath}" style="max-width: 100%; max-height: 70vh;" alt="Zdjęcie zadania">
      </div>
      <div>
        <button id="remove-bingo-photo">Usuń zdjęcie i zadanie</button>
        <button id="close-photo-modal">Zamknij</button>
      </div>
    </div>
  `;

    document.body.appendChild(modal);

    // Obsługa zamknięcia modalu
    document.getElementById('close-photo-modal').addEventListener('click', function() {
      document.body.removeChild(modal);
    });

    // Obsługa usunięcia zdjęcia i odznaczenia zadania
    document.getElementById('remove-bingo-photo').addEventListener('click', function() {
      if (confirm('Czy na pewno chcesz usunąć to zdjęcie i odznaczyć zadanie?')) {
        teamData[currentTeam].bingoMarked[taskIndex] = false;
        delete teamData[currentTeam].bingoPhotos[taskIndex];

        document.querySelector(`.bingo-item[data-index="${taskIndex}"]`).classList.remove('marked');
        updateBingoScore();
        updateScores();
        saveGameState();

        document.body.removeChild(modal);
      }
    });
  }

  // Funkcja aktualizująca wynik bingo
  function updateBingoScore() {
    let markedCount = 0;
    Object.values(teamData[currentTeam].bingoMarked).forEach(marked => {
      if (marked) markedCount++;
    });

    document.getElementById('bingo-score').textContent = `Bingo: ${markedCount}/25`;
  }

  // Funkcja zmiany zakładki
  function switchTab(tabId) {
    // Dezaktywuj wszystkie zakładki
    document.querySelectorAll('.tab').forEach(tab => {
      tab.classList.remove('active');
    });
    document.querySelectorAll('.tab-content').forEach(content => {
      content.classList.remove('active');
    });

    // Aktywuj wybraną zakładkę
    document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
    document.getElementById(tabId).classList.add('active');

    // Inicjalizacja mapy jeśli potrzebna
    if (tabId === 'map-tab' && !map) {
      setTimeout(initMap, 100);
    }
  }

  // Funkcja generująca opcje wyboru stacji
  function generateStationOptions() {
    const stationSelect = document.getElementById('station-select');
    stationSelect.innerHTML = '<option value="">Wybierz stację</option>';

    const teamStationOrder = teamData[currentTeam].stationOrder;

    teamStationOrder.forEach((stationId, index) => {
      const station = stations.find(s => s.id === stationId);
      const stationNumber = index + 1;

      const option = document.createElement('option');
      option.value = stationId;
      option.textContent = `${stationNumber}. ${station.name}`;
      stationSelect.appendChild(option);
    });
  }

  // Funkcja walidacji formularza dodawania punktów
  function validateStationForm() {
    const password = document.getElementById('station-password').value;
    const stationId = document.getElementById('station-select').value;
    const points = document.getElementById('points-input').value;

    const isValid = password === ADMIN_PASSWORD && stationId && points;
    document.getElementById('add-points-btn').disabled = !isValid;
  }

  // Funkcja dodawania punktów
  function addPoints() {
    const password = document.getElementById('station-password').value;

    if (password !== ADMIN_PASSWORD) {
      alert('Niepoprawne hasło prowadzącego!');
      return;
    }

    const stationId = parseInt(document.getElementById('station-select').value);
    const points = parseInt(document.getElementById('points-input').value);

    if (!stationId || isNaN(points)) {
      alert('Wybierz stację i podaj liczbę punktów!');
      return;
    }

    // Dodaj punkty dla wybranej stacji
    teamData[currentTeam].completedStations[stationId] = points;

    // Aktualizuj interfejs
    generateStationLists();
    updateScores();

    // Resetuj formularz
    document.getElementById('station-password').value = '';
    document.getElementById('station-select').value = '';
    document.getElementById('points-input').value = '10';
    document.getElementById('add-points-btn').disabled = true;

    // Zapisz stan gry
    saveGameState();

    alert(`Dodano ${points} punktów dla stacji ${stationId}!`);
  }

  // Funkcja aktualizująca wyniki
  function updateScores() {
    let stationsScore = 0;
    let bingoScore = 0;

    // Policz punkty ze stacji
    Object.values(teamData[currentTeam].completedStations).forEach(points => {
      stationsScore += points;
    });

    // Policz punkty z bingo (1 punkt za każde zaznaczone pole)
    Object.values(teamData[currentTeam].bingoMarked).forEach(marked => {
      if (marked) bingoScore++;
    });

    // Zaktualizuj sumę punktów
    teamData[currentTeam].totalPoints = stationsScore + bingoScore;

    // Aktualizuj wyświetlanie
    document.getElementById('stations-score').textContent = stationsScore;
    document.getElementById('bingo-points').textContent = bingoScore;
    document.getElementById('total-score').textContent = `${teamData[currentTeam].totalPoints} punktów`;
  }

// Function to load game state from the server
function loadGameState() {
  fetch('/api/game-data')
    .then(response => {
      if (!response.ok) {
        throw new Error('Failed to load game data');
      }
      return response.json();
    })
    .then(data => {
      if (data && Object.keys(data).length > 0) {
        // Update teamData with loaded data
        teamData = data;
        console.log('Game data loaded successfully');
        
        // If user is already viewing a team dashboard, refresh the UI
        if (currentTeam) {
          generateStationLists();
          generateBingoGrid();
          updateScores();
          if (map) {
            // Clear existing markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            // Reinitialize map with current team data
            initMap();
          }
        }
      } else {
        console.log('No saved game data found');
      }
    })
    .catch(error => {
      console.error('Error loading game data:', error);
      alert('Nie udało się załadować danych gry. Używam danych domyślnych.');
    });
}

// Function to save game state to the server
function saveGameState() {
  fetch('/api/game-data', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(teamData)
  })
    .then(response => {
      if (!response.ok) {
        throw new Error('Failed to save game data');
      }
      return response.json();
    })
    .then(result => {
      console.log('Game data saved successfully');
    })
    .catch(error => {
      console.error('Error saving game data:', error);
      alert('Nie udało się zapisać postępu gry. Spróbuj ponownie później.');
    });
}

// Function to reset the game (admin only)
function resetGame() {
  if (!confirm('Czy na pewno chcesz zresetować całą grę? Ta operacja jest nieodwracalna!')) {
    return;
  }
  
  fetch('/api/reset-game', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ adminPassword: ADMIN_PASSWORD })
  })
    .then(response => {
      if (!response.ok) {
        throw new Error('Failed to reset game');
      }
      return response.json();
    })
    .then(result => {
      alert('Gra została zresetowana!');
      
      // Reset local team data to default values
      teamData = {
        1: { name: "Drużyna Czerwona", color: "#e74c3c", stationOrder: generateTeamRoutes(), completedStations: {}, bingoMarked: {}, totalPoints: 0 },
        2: { name: "Drużyna Niebieska", color: "#3498db", stationOrder: generateTeamRoutes(), completedStations: {}, bingoMarked: {}, totalPoints: 0 },
        3: { name: "Drużyna Zielona", color: "#2ecc71", stationOrder: generateTeamRoutes(), completedStations: {}, bingoMarked: {}, totalPoints: 0 },
        4: { name: "Drużyna Żółta", color: "#f1c40f", stationOrder: generateTeamRoutes(), completedStations: {}, bingoMarked: {}, totalPoints: 0 },
        5: { name: "Drużyna Fioletowa", color: "#9b59b6", stationOrder: generateTeamRoutes(), completedStations: {}, bingoMarked: {}, totalPoints: 0 },
        6: { name: "Drużyna Pomarańczowa", color: "#e67e22", stationOrder: generateTeamRoutes(), completedStations: {}, bingoMarked: {}, totalPoints: 0 }
      };
      
      // Update admin panel
      generateAdminTeamList();
      
      // Go back to team selection
      backToTeamSelection();
    })
    .catch(error => {
      console.error('Error resetting game:', error);
      alert('Nie udało się zresetować gry. Sprawdź hasło administratora i spróbuj ponownie.');
    });
}


</script>
</body>
</html>